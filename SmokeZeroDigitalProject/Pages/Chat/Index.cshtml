@page
@model SmokeZeroDigitalProject.Pages.Chat.ChatPageModel
@{
    ViewData["Title"] = "Chat";
    Layout = "~/Pages/Shared/_Layout.cshtml";
    ViewData["CurrentUserId"] = Model.CurrentUserId; // 👈 Truyền vào để partial view dùng
}

@if (!Model.IsCoach && !Model.CanChat)
{
    <div class="alert alert-warning mt-4">Bạn cần có gói đăng ký (subscription) để sử dụng tính năng chat.</div>
}
else
{
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-4 border-end">
                <h5>Recent Conversations</h5>
                <ul class="list-group">
                    @foreach (var conv in Model.UserConversations)
                    {
                        var displayName = Model.IsCoach ? conv.UserName : conv.CoachName;
                        <li class="list-group-item @(conv.Id == Model.ConversationId ? "active" : "")">
                            <a class="text-decoration-none d-block" href="/Chat?conversationId=@conv.Id">
                                <strong>@displayName</strong><br />
                                <small class="text-muted">@conv.LastMessage</small>
                            </a>
                        </li>
                    }
                </ul>
            </div>

            <div class="col-md-8 d-flex flex-column" style="height: 80vh;">
                <div id="messageList" class="flex-grow-1 overflow-auto border rounded p-3 bg-white mb-2">
                    @foreach (var msg in Model.Messages)
                    {
                        await Html.RenderPartialAsync("_ChatMessage", msg);
                    }
                </div>

                <form id="sendMessageForm" class="d-flex gap-2">
                    <input type="text" id="messageInput" class="form-control" placeholder="Nhập tin nhắn...">
                    <button class="btn btn-primary" type="submit">Gửi</button>
                </form>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        window.chatConfig = {
            conversationId: '@Model.ConversationId',
            senderUserId: '@Model.CurrentUserId',
        };
    </script>
    <script src="~/js/chat.js"></script>
}
