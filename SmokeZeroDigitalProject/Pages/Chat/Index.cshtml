@page
@model SmokeZeroDigitalProject.Pages.Chat.ChatPageModel
@{
    ViewData["Title"] = "Chat";
    Layout = "~/Pages/Shared/_Layout.cshtml";
    ViewData["CurrentUserId"] = Model.CurrentUserId;
}

@if (!Model.IsCoach && !Model.CanChat)
{
    <div class="alert alert-warning mt-4">Bạn cần có gói đăng ký (subscription) để sử dụng tính năng chat.</div>
}

else
{
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-4 border-end">
                <h5 class="mb-3">Recent Conversations</h5>
                <ul class="list-group list-group-flush">
                    @foreach (var conv in Model.UserConversations)
                    {
                        var displayName = Model.IsCoach ? conv.UserName : conv.CoachName;
                        var avatarUrl = Model.IsCoach ? conv.ProfilePictureUrl : conv.CoachProfilePictureUrl;
                        var isActive = conv.Id == Model.ConversationId ? "active-conv" : "";

                        <li class="list-group-item py-2 px-0 border-0 @isActive conversation-item" data-id="@conv.Id">
                            <a href="/Chat?conversationId=@conv.Id" class="text-decoration-none text-dark d-flex align-items-center gap-2 px-3 py-2 hover-bg">
                                @if (!string.IsNullOrEmpty(avatarUrl))
                                {
                                    <img src="@avatarUrl" alt="avatar" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;" />
                                }
                                else
                                {
                                    var fallbackName = displayName?.Split(' ').LastOrDefault()?.ToUpperInvariant().FirstOrDefault();
                                    <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center fw-bold"
                                         style="width: 40px; height: 40px;">
                                        @fallbackName
                                    </div>
                                }
                                <div class="flex-grow-1">
                                    <div class="fw-semibold">@displayName</div>
                                    <small class="text-muted text-truncate d-block last-message" style="max-width: 180px;">@conv.LastMessage</small>
                                </div>
                            </a>
                        </li>
                    }
                </ul>
            </div>


            <div class="col-md-8 d-flex flex-column" style="height: 80vh;">
                <div id="messageList" class="flex-grow-1 overflow-auto border rounded p-3 bg-white mb-2">
                    @foreach (var msg in Model.Messages)
                    {
                        await Html.RenderPartialAsync("_ChatMessage", msg);
                    }
                </div>

                <form id="sendMessageForm" class="d-flex gap-2">
                    <input type="text" id="messageInput" class="form-control" placeholder="Nhập tin nhắn...">
                    <button class="btn btn-primary" type="submit">Gửi</button>
                </form>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        window.chatConfig = {
            conversationId: '@Model.ConversationId',
            senderUserId: '@Model.CurrentUserId',
        };
    </script>
    <script src="~/js/chat.js   "></script>
}
